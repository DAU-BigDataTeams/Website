---
title: Store Site Recommendation under the O2O Model via Multi-graph Attention Networks Paper reivew 작성중..
layout: post   
categories : paper, reivew, research
image : /assets/img/paperview/o2o/O2O 논문 썸네일.png
description: 온라인 - 오프라인 매장을 위해 적합한 매장 위치 추천 모델에 대한 논문
customexcerpt: O2O 모델에서 점주들의 필연적인 문제는 가게 위치를 선택하는 것 즉, 가게 위치 추천 문제다.
---

> [논문 원본](https://ieeexplore.ieee.org/document/9835449)  

# O2-SiteRec: Store Site Recommendation under the O2O Model via Multi-graph Attention Networks
title : Multi-graph Attention Networks를 통한 O2O 모델의 상점 위치 추천

[목차]
- [Introduction](#introduction)
- [Motivation](#motivation)
- [Design of O2-siteRec](#design-of-o2-siterec)
<!-- - [Evaluation](#evaluation)-->
<!-- - [Discission](#discission)-->

## Abstract
----
여러 배달 플랫폼을 기반으로한 O2O(Online - Offline) 매장의 등장은 사람들의 삶에 큰 편리함을 제공한다. O2O 모델에서 점주들의 필연적인 문제는 가게 위치를 선택하는 것 즉, 가게 위치 추천 문제다.  **우리는 전통적인 오프라인 매장에 대한 기존 작업이 1. 택배용량 및 파견 전략으로 인한 동적 공급 2. 배송 거리로 인한 다양한 고객요구를 포함하는 O2O 모델의 두 가지 고유한 요소로 인해 이문제를 해결 할 수 없다고 주장합니다.**  이러한 **새로운 요소를 통합하기 위해** 우리는 $O^2$-SiteRec, 다중 그래프 어텐션 네트워크를 통한 **O2O 모델의 매장 위치 추천 방법은 1. 배달 수용력 포착(capture)하기 위한 multi-semantic relation graph attention network기반 모델 2. 배달업체 수용력, 고객 선호도, 컨텍스트(전후사정?)특성이 융합된 이동성적 다중 그래프 기반 추천 모델이다.**
이 논문에서는 중국에서 가장 유명한 O2O 플랫폼 중 하나에서 39,465개의 매장과 2,360만 개의 주문으로 구성된 1개월간의 실제데이터를 기반으로 방법을 평가한다. 실험 결과는 그들의 방법이 다양한 메트릭에서 최첨단 기준선을 능가한다고 보여준다고 주장한다.

# Introduction
O2O(Online-to-Offline) 모델은 최근 몇 년 동안 점점 더 중요한 비즈니스 모델입니다. 일반적으로, 기존 오프라인 매장이나 신규 매장은 대규모 고객과 함계 O2O 플랫폼에 먼저 가입한 후 플랫폼에서 온라인 구매를 위해 고객을 안내한다. 소비자가 물건을 구매하면 플랫폼은 결제, 물류, 배송 등 나머지 절차를 완료한다. 이러한 모델의 전형적인 예는 Instacart, Uber Eats, 등..(우리나라로 치면 배달의 민족, 요기요, 배달통)과 같은 O2O 플랫폼을 통해 고객이 온라인으로 주문하는 주문형 배달앱이다. 주문이 시작되면 오프라인 상점에서 배달기사는 주문을 픽업해 짧은시간에 고객에게 배송한다.  

이 작업에서는 O2O 모델에서 매장 사이트 추천 문제를 대상으로 합니다. **기존 매장 추천 작업은 1. 소규모 설문조사 기반 방법 2. 대구모 데이터 기반 이렇게 두 범주로 나눌수 있다.** 설문 방법에서 사람들은 소규모 지원자로 부터 피드백을 얻기 위해 설문지와 인터뷰를 신중하게 설계하므로 **일부 편향된 피드백이 발생할 수 있다.**(아무래도 설문 문항을 다소 유리하게 작성하면 편향됨) 최근에는 스마트폰같은 기술 발달로 **체크인 데이터, 평점 데이터, 검색 엔진 쿼리와 같은 대규모 다중 소스 데이터를 수집할 수 있는 새로운 기회가 생겼습니다.** 연구원들은 이러한 데이터를 분석하고 기능 기반 머신 러닝 모델을 구축하여 매장에서 잠재적으로 높은 수익을 올릴 수 있는 위치를 식별한다. 이 논문의 작업도 위와 같은 범주에 속한다.(걍 저자도 데이터 분석하고 머신러닝 구축해서 했다~) 

그러나, 기존의 데이터 중심 연구는 주로 오프라인 매장을 위해 설계되었으며, 이는 수요와 공급 측면의 큰 차이로 인해 O2O 모델에서 매장 사이트 추천 문제를 해결하는 것이 적합하지 않다. 1. 공급 측면에서 오프라인 매장은 좋은 수용력 같은 요소에만 의존함. 하지만 이런 요인들 외에도 O2O 플랫폼의 배달 수용량에 따라 O2O 매장도 제약을 받는다. 예를 들어 배달의 수용량이 실시간 고객 수요를 충족할 수 없는 경우(주문 폭주??) 수요를 줄이기 위해 매장의 배달 범위를 축소시켜서 주문 수를 직접적으로 감소 시킨다. 2. 수요 측면에서, 이전 연구는 고객 소비 행동에 기반한 매장 수준 고객 선호도의 유용성을 검증했다. 하지만, 서비스가 오프라인에서 온라인으로 변화함에 따라 고객의 소비 행동도 진화한다. 예를 들어, 짧은 배달을 보장하기 위해 사람들이 직접 이동할 수 있기 때문에 전통적인 오프라인 서비스에 국한되지 않는 멀리 떨어진 매장에서 주문을 할 수 없다.(그냥 가까운 매장은 직접 찾으러 가서 굳이 멀리 떨어진 위치의 음식을 시간까지 써가며 배달 받지는 않는다?) 

이러한 격차를 해소하기 위해 이들은 수요와 공급의 새로운 측면을 고려해 O2O 매장을 위한 매장 사이트 추천 프레임워크를 설계하는 것을 목표로 한다. 이들의 작업 기회는(프레임워크 개발 기회) O2O 플랫폼이 회계 목적으로 배달 및 고객의 정보를 자연스럽게 기록하여 O2O 모델에서 매장 위치 추천에 대한 수급의 풍부한 정보를 제공한다는 것이다.(즉, O2O 플랫폼이 데이터를 방대하게 수집하고 있어서 작업하기 좋았다) 1. 공급 측면에서 플랫폼은 배달 업체의 스마트폰에 배포된 온라인 지도 서비스의 API로 부터 배달 기사의 궤적 데이터를 수집하여 매장 사이트 추천에 대한 배달 수용량의 영향을 탐색할 수 있는 기회를 제공합니다. 2. 수요 측면에서 주문 기록은 세분화된 고객 선호도를 활용할 수 있는 기회를 제공한다.(리뷰, 평점, 검색 기록 등등) 

**매장 위치 추천을 위해 이러한 기회를(O2O 플랫폼의 데이터) 활용하는 것은 다음과 같은 문제가 있다. 1. 공급 측면에서 배달 수용량과 수용량과 O2O 매장 추천 위치 간의 관계를 정량화하는 것은 간단하지 않다. 배달량을 계산하는 순진한 솔루션이 실제 배달량을 반영할 수 없다는 것을 발견했다. (섹션 2-B1) 또한 배달량은 매장의 배달 범위와 고객 선택에 동적으로 영향을 미치므로 복잡한 관계가 된다. 2. 수요 측면에서 주변 고객이 O2O 매장 위치 추천에 미치는 영향은 배달 수용량, 배달 거리, 고객 선호도 및 역사적 상호작용을 포함한 여러 동적 이동성적 요인에 의해 영향을 받는다.** 이런 이동성적 요인의 영향을 O2O 매장 위치 추천에 융합하는 것은 어려운 일이다.  

이런 문제를 해결하기 위해 저자들은 $O^2$-SiteRec 즉, multi-graph attention networks기반 매장 위치 추천 프레임워크를 설계한다. 공급자 측면에서는 배달 수용량을 파악하기 위해 배달 유동성 multi-graph를 구성하고 배송 시간을 활용하여 배달 능력을 정량화한다. 이 그래프 기준으로, **세분화된 배달 수용량 특징을 얻기 위해 multi-semantic relation graph attention network을 기반으로 배달 수용량 모델을 설계한다.**  수요자 측면에서 서로 다른 기간의 지역 및 매장 유형에 대한 여러 관점 간의 복잡한 의미론적 관계를 모델링하는 지역 유형 이동성 다중 그래프를 구성한다. **저자들은 위치 추천을 위한 여러 이동성 요인 및 기타 상호 작용 정보에 의해 영향을 받는 고객 선호도를 포착하기 위해 이동성 다중 그래프 기반 추천 모델을 설계한다.** 특히, 저자들의 주요 기여는 아래와 같다.

1. O2O(Online - to - Online) 모델에서 매장 위치 추천 연구는 저자들이 처음이다. **이들은 공급(배달 물량 증가)과 수요(소비 패턴의 진화 등)측면에서 분석한다.** 이런 특성은 O2O 모델에서 매장 위치 추천에 필수적이며, 이를 통해 기존 매장 위치 추천 방법의 한계를 해결할 수 있습니다.

2. 저자들은 $O^2$-SiteRec이라는 Multi-graph attention networks를 통해 O2O 모델에서 새로운 매장 위치 추천 프레임워크를 설계한다. 이것은. 1. 배달 수용량 특징을 포착하기 위한 multi-semantic relation graph attention network에 기반한 배달 수용량 모델. 2. 배달업체 수용량, 고객 선호도 및 컨텍스트(전후사정?) 기능이 융합된 노드 수준 및 시간 의미 체계 수준 집합이 포함된 이동성 다중 그래프 기반 추천 모델이다. 

3. 우리는 가장 큰 O2O 플랫폼 중 하나인 Eleme(한국의 배민과 유사)에서 39,465개의 매장과 2,360만 건의 주문으로 구성된 1개월 간의 실제 데이터를 기반으로 프레임워크를 평가합니다. **매장 위치 추천 방법, 그래프 기반 일반 추천 방법 및 이동성 그래프 방법을 포함한 세 가지 기준 범주로 모델을 비교합니다.** 실험 결과는 제안된 접근 방식이 NDCG@3 메트릭에서 12.18% 개선과 Precision@3 메트릭에서 9.01%의 개선을 나타내는 다른 최첨단 방법보다 성능이 우수함을 보여줍니다. 또한 모델의 핵심 구성 요소(ex. 배달 수용량 모델, 지역 유형 이동성 그래프 기반 추천 모델 및 관심 메커니즘)의 효율성과 다양한 요인(ex. 다양한 매장 유형 및 다양한 분포)의 영향을 엄격하게 평가한다.(ex. 서로 다른 매장 유형 및 후보 지역 집합의 서로 다른 분포). 결과는 이러한 중요 구성 요소가 매장 위치 추천 효과를 높이고 그들의 모델이 이런 다양한 요인에 대해 잘 수행됨을 보여준다.



# Motivation
이 섹션은 먼저 데이터 셋의 세부 정보를 소개한 다음 설계에 동기를 부여하는 공급 측면(배달 수용량)과 수요 측면(소비자 패턴분석)에 대한 관찰 내용을 설명한다. 
## A. Data
----
이들의 작업은 Eleme이라는 가장 큰 O2O 플랫폼 중 하나를 기반으로 하며, 여기서 우리는 (i). 주문 데이터 (ii). 배달 궤적(배달 경로??)데이터 (iii). 컨텍스트 데이터를 포함한 세 가지 유형의 데이터를 활용합니다.   

**Order Data** : 주문 데이터의 레코드는 (i). 주문 배송을 위한 소스 위치(즉, 매장 위치) 및 목적지 위치(즉, 고객의 위치)와 같은 공간 정보 (ii). 주문 생성 시간, 주문 픽업 시간 및 배달기사 측이 전송한 배달 시간 같은 시간적 정보를 포함하는 정보를 기록한다. 게다가 고객과 매장 간의 거리, 매장 유형과 같은 다른 컨텐스트도 있다. 이 작업에 사용된 필드를 표1에 나열합니다. 전체적으로 주문 데이터에는 2020년 10월 부터 2020년 11월까지(1개월) 중국 상하이에서 122가지 유형(가벼운 식사, 커피 및 스낵)의 39,465개 매장과 관련된 2,360만 건의 주문이 포함된다. 개인 정보를 보호하기 위해 모든 고객 ID는 플랫폼에서 익명으로 처리된다. 또한 고객의 정확한 위치는 500m x 500m 크기의 영역으로 표시된다. 또한 개별 고객의 정보를 공개하지 않는 지역 수준의 집합이 고객 통계를 활용합니다. 마찬가지로 상점 정보도 개인 정보 보호를 위해 사전 처리된다.  

**Couriers' Trajectory Data** :  배달기사의 궤적 데이터는 배달기사가 근무할 때 스마트폰에서 획득한 연속적인 위치 정보를 담고 있다. 위치 정보는 택배 ID, GPS 위치 및 타임 스탬프를 포함하여 택배 동의하에 20초마다 플랫폼에 업로드 된다.  

**Context Data** : 컨텍스트 정보를 나타내는 POI(Point of Interset) 및 도로 네트워크를 포함한 공공 데이터를 도입합니다. 이들은 온라인 지도 서비스 제공자로 개방형 API 기반의 POI 데이터를 얻고 OpenStreetMap에서 도로 네트워크를 추출합니다.(OSMnx) 이러한 데이터는 매장 사이트 추천에 중요한 도시의 여러 지역의 특징을 설명하는데 활용됩니다. 

![Table 1.](/assets/img/paperview/o2o/O2O%20Table1.png)
## B. Supply Aspect : analysis of courier capactiy
---
**배달 수용량을 정령화하는 방법과 배달 용량이 매장과 고객에게 미치는 영향에 대해 논의합니다.**   

(1) 배달 수용량을 어떻게 정량화하나 : 배달 수용량을 정량화하는 간단한 방법은 배달건수를 세는 것입니다. **Fig. 1을 보면 상하이에서 2시간 간격으로 배달건수(공급자입장),주문 수량(수요자입장) 그리고 공급-수요 비율(배달건수를 주문 수량으로 나눈 값 즉,$배달건수/주문량$)을 나타낸다.** <u>배달건수와 주문 수량은 정규화된것 이다.</u> 오전  10시~오후 2시(정오, 출퇴근)와 오후 4시~오후 8시(저녁, 출퇴근)에 배달 및 주문량이 가장 많은 것으로 나타났다. 배달건수를 활용해서 배달 수용량을 정량화하면 두 기간(정오, 저녁)동안 배달 수용량이 충분한 것으로 간주된다. 그**러나 실제로는 두 기간 동안 주문량이 폭증하여 각 배달원에게 여러 개의 주문이 할당되고 있으며(배달원 1인당 많은 배달량), 배달건수를 집계한 배달 수용량은 과소 평가되고 있다.(더 여유있다?)** 하지만 공급-수요 비율은 배달 용량을 나타내는데 활용할 수 있다. Fig. 1에서 보는 것 처럼 정오 출퇴근 시간대와 저녁 출퇴근 시간대에 공급-수요 비율이 낮아 배송 능력이(수용력) 낮음을 알 수 있다.

위에서 언급한 공급-수요 비율은 도시 수준이지만 입지 추천을 위한 보다 세분호하된 공간 세분화를 갖는 지역 수준의 공급-수요 비율을 반영하지 않는다.(도시 수준은 말그대로 도시 전체, 지역 수준은 도시의 일부 구역). 지역별 공급-수요 비율 계산식을 직접 적용하는 것은 배달원의 지역 간 이동성과 동시 발주로 인해 부정확하다. 문제를 해결하기 위해 직관적으로 배송 시간을 배송 능력 측정 기준으로 사용한다. 예를 들어, 배달 수용량이 제한될 경우 각 배달원한테 여러 주문을 할당하고 그로인한 장거리 배송이 포함되어 배송시간이 오래 걸린다. 저자들은 배송 수용량(즉, 공급-수요 비율)과 배송 시간의 상관관계를 더 연구한다고함. 1개월 동안 전체 도시를 대상으로 2시간 마다 공급-수요 비율과 배송 시간을 계산한다. **Fig. 2.를 보면 배달원의 배송시간은 배달 수용량(능력)과 관련이 있어 도시 차원의 공급-수요 비율과 일치함을 알 수 있다.** 다음 분석 및 설계에서는 배송 시간을 활용하여 배달 수용량(능력)을 정량화 한다.

(2) 배달 수용량이 매장에 미치는 영향력 : Fig. 3.은 오전, 출근시간, 오후, 퇴근시간, 야간 5가지 시간대별 매장의 평균 배송 범위(가장 먼 배송 거리 기준)를 분석한 것이다. 예를 들어, 오후와 밤에 비해 출근시간에는 배송 용량이 제한되고 배송 범위가 줄어든다.(**즉, 해당 시간 동안 매장은 더 작은 지역으로 배송할 수 있음을 의미함.**) 배송 능력의 영향으로 인해 다른 시간대의 매장은 배송 범위가 다르다. 좋은 고객 경험을 보장하기 위해 플랫폼은 고객 만족도 및 피드백을 모니터링하여 높은 수준의 품질을 유지를 위해 작업한다. 플랫폼은 전달 범위를 확장하거나 축소하여 전달 압력을 제어한다. 플랫폼은 배송 범위를 확장/축소해서 배송 범위를 제어한다. 각 매장에서는 여러 단계 배송 범위가 있다. 출퇴근 시간에는 용량이 제한되기 때문에 플랫폼은 배송 범위를 축소한다. 오후에는 고객 유치를 위해 배송 범위를 확대할 것으로 보인다.
(주문량 높으니까) 따라서 배송 수용량(능력)은 매장의 배송 범위를 결정하며 이는 주문량에 직접적인 영향을 미친다.(배송 범위가 넓어지면 더 많은 지역의 사람들에게 배너가 노출되고 때문에 그들이 배달 주문으로 음식을 시키기 때문에 주문량 증가 효과.)

(3) 배달 수용량이 소비자에게 미치는 영향력 : Fig. 4.와 같이 동일한 배송거리 즉, 2.5km\~3km에서 5가지 시간대로 배송 능력 분포를 분석했다.
지역별 배송 능력이 다르기 때문에 같은 배달거리라도 배달시간이 다르다. 각 기간의 배송 능력은 일정하지 않으며 시간이 지남에 따라 변경됨을 나타낸다. 2.5km ~ 3km의 배송거리를 기준으로 정오와 evening 출퇴근 시간에 20\~30분의 배송시간을 가진 매장을 선택하는 경향이 있다. 배송시간이 길어질수록 고객이 긴 대기 시간을 견딜 수 없기 때문에 해당 주문 수는 점차 감소한다. 즉, 배송 능력은 고객의 시간 경험과 선택에 영향을 미칩니다. 조건이 허용되는 경우 고객은 주문이 가능한 빨리 도착하기를 원한다.(걍 고객은 빨리 받고싶어한다.) 배달 시간이 너무 길면 고객이 매장을 선택할 확률이 낮아진다.

(4) 요약 : **배달은 매장과 고객 사이의 연결 고리 역할을 하며 배송 능력은 매장과 고객 모두에게 큰 영향을 미친다. 한편 배송 능력은 매장의 배송 범위를 결정하며 매장 주문량에 직접적인 영향을 미친다. 반면 배송 능력은 고객의 시간 경험과 선택에 영향을 미치며 이는 매장 주문에 간접적으로 영향을 미친다.(그냥 배송 능력이 매장의 배송 범위에 2가지 방식으로 영향을 미친다.)**

## C. Demand Aspect : analysis of customer behavior
----
(1) 고객 선호와 주문과 상관관계 : 각 지역의 주문에 대해 각 유형의 주문 수를 계산합니다. 고객 선호도는 주어진 범위(ex. 3km) 내에서 가까운 지역의 고객으로부터 유형별 주문 건수를 카운트한다. 그다음 주문과 고객 선호도 간의 [Pearson](https://webnautes.tistory.com/1685) 상관관계를 계산한다.
> Pearson 상관계수 사용 이유 추측 : 연속형 변수 2개의 선형관계를 확인할 때 사용하기 때문에 사용  
> Spearman Rank 상관계수는 정규성을 따르지 않을 때 사용 그리고 순위를 이용하기 때문에 현재 상황에 부적합  
> Kendall Tau는 스피어만 순위와 거의 비슷한 개념인데 연속형 변수 간의 순위를 비교해서 계산함(부적합)   
> Point-biserial는 하나의 변수가 이분형(T/F)이고 다른게 연속형인 경우 측정 방식임(부적합)
> Phi는 독립변수와 종속변수가 모두 이분형 변수인 경우 사용(부적합)

![Table 2.](/assets/img/paperview/o2o/O2O%20Table2.png)  

결과를 표2에 표시합니다. 고객 선호도와 주문 간의 상관계수가 범위에 따라 0.7보다 큰 것을 볼 수 있다. 상관 계수가 0.6보다 크면 일반적으로 강한 상관 관계가있는 것으로 간주된다. 또한 다양한 범위에서 미세한 차이가 있다. 2~3km 주변의 고객 선호도는 이러한 고객이 해당 매장의 주요 소비자라서 가장 관련성이 높다. 3km 이상의 매장의 경우 배송 범위에서 제외될 수 있습니다. 2km 이내 매장의 경우 고객이 O2O 서비스를 이용하지 않고 직접 수령을 선택할 수 있습니다.

(2) 다른 기간의 고객 선호도 : 도시 전체에서 5개의 시간대 동안 각 매장 유형의 총 주문 수를 계산한 다음 순위를 매긴다. 각 시간별 상위 3개 매장 유형을 선택하여 다양한 기간의 고객 선호도를 연구한다.   
![Fig. 5.](/assets/img/paperview/o2o/O2O%20Fig.%205.png)  
그림 5에서 볼 수 있듯이 다양한 시간대에 고객의 선호도가 다른 것을 알 수 있습니다. 이 현상에는 두 가지 주요 이유가 있다. (i). 다양한 시대의 고객 선호도는 본질적으로 다르다. (ii). 동일한 지역에 다른 기간에 다른 인구가 있습니다. 예를 들어 어떤 사람들은 아침에 한 지역에서 일하고 저녁에 퇴근한 후 다른 지역으로 돌아간다.

(3) Summary : 분석 결과를 보면 고객 선호도와 주문가의 상관계수가 높게 나타났고, O2O 모델에서 고객 선호도가 매장 위치 추천에 가장 중요한 역할을 한다. 더 나아가, 선호하는 매장이 하루에 따라 바뀌기 때문에 고객 선호도는 시간이 지남에 따라 변하므로 모델링 부분에서 다양한 기간을 고려하도록 동기를 부여한다.


# Design of O2-siteRec

## A. Preliminary
----

**Definition 1: Region.** (정의 1. 지역) 도시는 크기가 $500m$ x $500m$인 2차원 그리드로 분할된다.(미터 단위는 변수임) 각 그리드는 지역을 의미한다.  
**Definition 2: Region Georaphical Graph.**(정의 2. 지역 지리적 그래프) 그래프 $G_{ge}$ = {V, $E_{ge}$}를 사용하여 지역 간의 지리적 근접성을 모델링한다. 여기서 V는 지역을 나타내는 노드 $r∈R$이 있는 노드 집합을 나타내고 엣지 $E_{ge}$($r_i$,$r_j$)는 $r_i$와$r_j$  사이의 연결을 나타내며, 그 거리는 임계값 (즉, 800m)보다 작다. $E_{ge}$($r_i$,$r_j$)의 속성은 두 지역 사이의 거리다.  
**Definition 3: Courier Mobility Graph.**(정의 3. )  그래프 $G_{tc}$ = {V, $E_{tc}$}를 활용하여 기간 t동안 지역 간 배달의 실제 배달 시간을 모델링합니다. 여기서 $E_{tc}$는 배달이 $r_i$ 와 $r_j$ 사이에서 이동성(이동성??) 동적을 가짐을 나타낸다. 엣지의 속성은 $r_i$에서 $r_j$까지의 배송 시간이다. 또한 운송자의 이동 상태는 시간이 지남에 따라 변한다. 저자들은 이런 이질적인 상호작용을 표현하기 위해 다중 그래프 구조를 사용한다. 운송자 이동 다중 그래프(Courier mobility multi-graph)는 $G_c$ = ∪{$G^t_c$} = (V, $E_c$)로 정의되며, $E_c$ = {$E^{t_1}_c, E^{t_2}_c, ...$}는 다른 기간동안의 간선 집합을 나타냅니다. **(수식은 본 논문을 참고할 것)**  
**Definition 4: Region-Type Het-erogeneous Graph.**(정의 4. 지역 유형 이동성 그래프) 각 지역에는 매장 전망와 고객 전망 두 가지가 있다. 매장 전망에서는 이 지역에서 어떤 유형의 매장이 사용 가능한지를 나타내는 store-region을 정의한다. 고객 전망에서는 이 지역의 고객들이 선호하는 유형의 매장을 나타내는 customer-region을 정의한다. 이러한 상점-지역과 고객-지역은 모든 지역의 하위 집합이다. 이동 그래프 $G^t_h$ = {$V_h,E^t_h,X_h$}를 사용해서 Fig. 6.에 표시된 `Period t`에서 서로 다른 보기 및 매장 유형의 지역 간 관계를 모델링합니다. $V_h$는 store-region 노드 $s ∈ S$ customer-region 노드 $u ∈ U$ 그리고 store-type 노드 $a ∈ A$로 구성된 노드다. $X^t_h$는 노드의 속성이며 섹션 III-C에서 자세하게 설명한다. $E^t_h$는 S-U 에지 $E^t_{S-U}$, S-A 엣지 $E_{S-A}$ 및 U-A 에지 $E^t_{U-A}$로 구성된 엣지다.

![Fig. 6.](/assets/img/paperview/o2o/O2O%20Fig.%206.png) 

- $E^t_{S-U}(s,u)$는 기간 t에서 고객 지역 u가 매장 지역 s의 배송 범위에 있음을 의미한다. 과거 배송 범위 및 거리를 기반으로 확률을 계산하고 매장의 배송 범위에 대한 배송 능력(수용량)의 영향을 고려하기 위해 노드 사이에 엣지가 있는지 확인한다. 특히 대상 지역의 경우 먼저 가장 먼 배송 거리 내에서 후보 지역을 축소시킨다. 거리가 평균 배송 거리보다 짧으면 대사 지역과 후보 지역 사이에 엣지를 구축한다. 그게 아니면 주문 비율(즉, 대상 지역이 있는 이러한 후보 지역의 과거 주문 수를 대상 지역의 총 역사적 주문 수로 나눈 값)을 계산하여 엣지가 있는지 여부를 결정한다. 일부 예외 주문이 있을 수 있으므로 주문 비율이 낮은 지역을 필터링한다. 엣지 속성 $φ_{su, t}$는 기간 t에서 고객과 매장 간의 상호작용에 영향을 미치는 다양한 요인으로 구성된 이동성 벡터다.(자세한 내용은 III-C에서..)

- $E_{S-A}$(s, a)는 store-region s에 store type이 a인 매장이 있음을 의미합니다. 에지 속성 $φ_{sa}$는 다차원 벡터로 상업적 기능과 이력 주문 번호를 포함합니다(세부 사항은 섹션 III-C 참조).

-  $E^t_{U-A}$(u, a)는 고객 영역 u에 있는 고객이 기간 t에서 점포 유형이 a인 점포를 선호함을 의미한다. 엣지 속성$φ_{ua, t}$는 과거 거래 수다.  
    
또한 고객 선호도와 고객-지역과 매장-지역 간의 상호 작용은 시간이 지남에 따라 변하며, 이는 서로 다른 기간에 따라 엣지가 다르다는 것을 의미한다. 변경 사항을 통합하기 위해 Region-Type 이동성 다중 그래프를 $G_h$ = ∪ {$G^t_h$} = $(V_h,E_h,X_h)$로 정의합니다. 여기서 $E_h$ = {$E^{t_1}_h$ ,$E^{t_2}_h$ , ...}는 서로 다른 기간의 엣지 세트를 나타낸다. 

**문제 공식화** 우리는 O2O모델에서 매장 추천 문제를 다음과 같이 공식화 한다.  
![공식1](/assets/img/paperview/o2o/O2O%20공식1.png)    
$G_{ge}$는 지역 s에서 대상 유형 a(ex. 가벼운 식사 및 스낵)의 주문 수 $P_{sa}$를 예측할 수 있는 모델 Fθ를 학습한다. 모델을 활용하여 모든 후보 매장 지역 S = ($s_1, s_2, ...,s_j$)에 대한 주문 수를 예측하고 상위 순위 지역을 추천 결과로 선택한다.  

## B. Overview
-----
$O^2-SiteRec$의 프레임워크는 Fig. 7.에 있으며, 3가지 모듈로 구성된다.

![Fig. 7.](/assets/img/paperview/o2o/O2O%20Fig.%207.png)

1. 데이터 처리 : 먼저 컨텍스트 데이터와 주문 데이터에서 기능을 추출한다. 이러한 특징은 지역 유형 이기종 다중 그래프에서 노드와 엣지의 속성으로 활용된다(섹션 III-C절 참고.)
2. 배달 능력 모델링 : 배달 이동성 다중 그래프를 기반으로 지역 유형 이기종 다중 그래프의 입력으로 활용되는 세분화된 배달 능력 임베딩을 포착하기 위한 배달 능력 모델을 설계한다.(섹션 III-D절 참고.)
3. 이기종 다중 그래프 기반 추천 : 배달 능력 모델의 지역형 이기종 다중 그래프 및 엣지 임베딩을 기반으로 노드 수준 및 의미 수준 집계를 통해 이기종 다중 그래프 기반 추천 모델을 설계하여 여러 요소에 영향을 받는 고객 선호도와 매장 간의 상호 작용 그리고 상점 유형 정보를 포착한다.(섹션 III-E절 참고.)

## C. Data Processing
----
먼저 지역별 POI 집합, POI 다양성, 교통 편의성, 점포 다양성 등의 지리적 특징을 추출한다. 이러한 지리적 특징은 매장 지역 노드와 고객 지역 노드 모두의 속성으로 간주된다.

- POI Set : 각 차원이 각 지역의 특성 유형에 있는 POI 수를 나타내는 벡터입니다.
- POI 다양성 : 한 지역에 나타나는 모든 유형의 POI 비율의 정보 엔트로피로 정의된다.
- 교통편의성 : 한 지역의 교차로와 도로의 수로 구성된 벡터
- 점포 다양성 : 한 지역에 있는 모든 유형의 점포 비율의 정보 엔트로피로 정의된다.

또한 점포 영역 s의 특정 유형a에 대해 경쟁력과 보완성을 포함한 상업적 특징을 추출한다. 이러한 기능은 ES-A의 속성입니다. 
- 경쟁령 : 인근 동종 점포와의 경쟁을 반영하며, 해당 지역의 동종 점포 수를 인근 점포의 총 수로 나누 값으로 정의
- 상호보완성 : 커피숍과 빵집과 같이 상호보완적인 특성 때문에 서로 다른 유형의 매장이 잠재적으로 서로에게 이익이 될 수 있음을 나타낸다. 관련 수식은 다음과 같다. 
-  ![O2O fcpsa.png](/assets/img/paperview/o2o/O2O%20fcpsa.png) 여기서 ![1](/assets/img/paperview/o2o/1.png) = ![2](/assets/img/paperview/o2o/2.png)
-  ![3](/assets/img/paperview/o2o/3.png)는 지역 s에 유형 a의 점포가 있는 갯수, ![4](/assets/img/paperview/o2o/5.png)는 모든 지역에서 평균적으로 등장하는 유형 a 점포의 갯수  
-  ![5](/assets/img/paperview/o2o/4.png)는 유형 $a^*$와 a가 함께 등장하는 횟수, ![6](/assets/img/paperview/o2o/6.png)는 점포의 총 유형 수이다.

이외에도 이에 관련된 특징을 추출하는 것도 수행한다.

또한 EtS-U의 속성으로 사용되는 거리, 과거 거래 기록 등 고객-지역과 매장-지역 간의 상호작용에 영향을 미치는 특징을 추출한다.
- Distance : 점포지역과 고객지역 사이의 거리로 정의함
- 과거 거래 기록 : 매장 지역과 고객 지역 간의 과거 거래 수로 정의

![Fig. 8.](/assets/img/paperview/o2o/O2O%20Fig.%208.png)
> 그림 8은 배달 능력 모델 설계다. 
> 각 지역 노드에 대해 지리 의미 집합 및 이동성 의미 집합에 의해 임베딩된 노드를 얻는다.
> 우리는 배달 이동성 그래프에서 이동성 에지의 속성을 재구성하기 위해 에지 임베딩으로 두 개의 노드 임베딩을 연결한다.
> 얻은 배달 능력의 엣지 임베딩을 출력한다.  
  
## D. Courier Capacity Modeling
-----
배달의 이동성으로 인해 세분화된 배달 능력을 파악하는 것은 간단하지 않다. 직관적으로, 지리적으로 인전합 지역은 배달 능력이 비슷하고 이동성 관계가 있는 지역은 어느 정도 상관관계가 있다. 우리는 배달 수용량을 관측하기 위해 ```multi semantic relation graph attention network```를 기반으로 배달 수용량 모델을 설계한다. 

기간 t의 각 하위 그래프 $G^t_c$에 대해 그림 8 과 같이 다음 단계를 수행한다. 

1. 각 노드에 대해 두 종류의 이웃, 즉 지역 지리적 그래프와 배달 이동성 그래프에서 각각 지리적 의미의 집합과 이동성 의미의 집합을 찾는다
2. 배달 이동성 그래프에서 edge의 속성을 재구성하기 위해 edge 임베딩으로 연결되는 지리적 의미의 집합과 이동성 의미의 집합에 의해 임베딩된 노드를 얻는다.
3. edge 임베딩은 지역 유형 heterogeneous (이종) Multi-graph의 입력으로 활용된다.(섹션 III-E 참고)
> ```Heterogeneous graph```는 반대로 그래프의 노드가 여러 종류의 성질을 가지는 그래프이다. 예를 들어 영화-유저 그래프는 어떤 노드는 영화이고, 어떤 노드는 유저를 의미하는 heterogeneity를 갖는다.
4. 이 모듈의 훈련은 주요 작업의 훈련을 최적화하기 위한 보조 작업으로 활용된다.



(1). **지리적 의미의 집합** : 초기 임베딩 $b^0_i∈ R^d_1$로 각 지역 i를 나타낸다. 여기서 $d_1$은 임베딩 크기를 뜻 한다. ($R^d_1$여기 있는 d1말하는거임) 지역 i의 지리적 이웃 $N^{geo}_i$에 대해 지역 간 거리를 활용하여 가중치를 계산합니다. 이는 다음과 같이 정의됩니다.  
![D-2](/assets/img/paperview/o2o/D-2.png)    

여기서 dis(i, j)는 지역 i와 지역 j 사이의 거리를 나타낸다. 다음과 같이 정의되는 I번째 지리적 의미 집합에 의해 지역 i의 임베딩 $b^I_{g,i}$를 얻는다.    
![D-3](/assets/img/paperview/o2o/D-3.png)    

여기서 $b^{I-1}_{g,i}$은 (I-1)번째 지리적 의미 집합 집계 후 지역 j의 임베딩을 나타내고 $σ(·)$는 활성화 함수다(activation funcion).   

(2). **이동성 의미 집합** : 지역 i의 의미적 이웃 $N^{mod}_i$에 대해 GAT[23]에 따라 서로 다른 이웃 간의 가중치를 계산합니다. 이는 다음과 같이 정의한다. $α^{mob}$(i,j) = $softmax(σ(ψ^T [b^0_i, b^0_j])).$ 그런 다음 이동성 의미 집합을 집계 후 지역 i의 임베딩 $b_{s,i}$를  얻는다.    
![D-4](/assets/img/paperview/o2o/D-4.png)    

여기서 ψ는 매개변수화된 attention vector이다. $b^0_i$ 및 $b^0_j$는 각각 지역 i,j의 초기 임베딩이다.

(3). **배달 이동성 그래프에서 이동성 edge의 속성을 재구성하여 edge 임베딩 획득** :  지역 i의 최종 임베딩 $b_i$는 다음과 같이 정의되는 두 가지 측면(지리적 및 이동성)의 임베딩을 결합하여 계산된다.    
![D-5](/assets/img/paperview/o2o/D-5.png)  

여기서 $W_b$는 학습(훈련) 가능한 가중치이다.(훈련 가능한..?). 두 지역 임베딩을 Edge임베딩 $em^c_{i,j}$로 결합한 다음 $DˆT_{i,j}$ =  $σ(W_1[b_j , b_i])$으로 정의되는 배달 시간 예측을 위해 MLP에 주어진다. $W_1$은 훈련 가능한 가중치를 말한다. loss function은 다음과 같이 정의된다.  
![D-6](/assets/img/paperview/o2o/D-6.png)  

|E| 배달 이동성 그래프에서 관측된 edge의 수다. $DT_{i,j}$는 배달 이동성 그래프의 실제 배달 시간이다.($DˆT_{i,j}$이거는 예측값 즉, 위 식은 L1 Loss 같음) 배달 수용량을 포함하는 edge 임베딩은 지역 유형 heterogeneous multi-graph(이종 다중 그래프)의 입력으로 활용됨  

## E. Heterogeneous Multi-graph based Recommendation(이종 다중 그래프 기반 추천)
----
직관적으로, **지역이 특정 매장 유형에 적합한지 여부는 주변 고객 선호도에 영향을 받는다.** 매장 - 지역, 고객 - 지역, 매장 유형  간의 복잡한 관계를 모델링하기 위해 지역 유형 이종 다중 그래프를 구성합니다. 구체적으로 우리는 위치 추천을 위해 매장-지역 및 매장 유형 간의 고객 선호도 및 상호 작용 정보를 관측하기 위해 이종 다중 그래프 기반 추천 모델을 설계합니다. 이 모델에서는 edge 속성(ex. 여러 요인)의 영향을 고려하기 위한 노드 수준 집합과 다중 그래프 구조를 고려하기 위한 시간 의미 체계 수준 집계가 포함되어 있습니다. 

Fig 9는 이종 다중 그래프 접근 방식을 사용하는 추천 모델을 보여준다. (1) 노드 속성 결합, (2) $E^t_{S-U}$ 그래프에 대한 edge 속성 결합, (3) 노드 수준 데이터를 집계하여 서로 다른 기간 동안 매장-지역 및 매장-유형 임베딩을 얻는 5가지 주요 단계가 포함됩니다. (4) 시간-의미 집합을 사용해 서로 다른 하위 그래프의 결과를 결합하고, (5) 주문 수를 예측합니다.

>즉, 위에서는 다양한 유형의 그래프를 사용하는 추천 모델을 보여주고 5가지 단계로 구성된다.
> 1. 노드의 속성을 결합하는 과정
> 2. $E^t_{S-U}$ 그래프에 edge 속성을 결합하는 과정
> 3. 매장-지역과 매장-유형을 구하기 위해 노드 레벨의 데이터를 집계하는 과정
> 4. 시간-의미적 수준에서 결과를 결합하는 과정
> 5. 주문 수를 예측하는 과정

-----

![fig. 9.](/assets/img/paperview/o2o/O2O%20Fig.9.png)

**(1) 노드 속성 융합 :**  각 노드 ID를 잠재적 특징을 나타내는 임베딩으로 표현한다. **구체적으로, 매장-지역은 s, 고객-지역은 u 및 매장-유형은 a를 초기 임베딩 $h'_s$ ∈ $R^{d_2}$ , $z'_u$ ∈ $R^{d_2}$ 및 $q'_a$ ∈ $R^{d_2}$ 로 나타낸다.** 여기서 $d_2$는 임베딩 크기다. 그다음 초기 임베딩과 노드 속성을 융합하여 노드 융합 임베딩을 얻는다. 매장-지역, 고객-지역, 매장-유형의 융합 임베딩은 $h^0_s$ = σ(WS[$h'_s$, $f_s$]), $z^0_u$ = σ(WU[$z'_u,$ $f_u$]) 및 $q^0_a$ =$q'_a$ 로 정의된다. 

**(2) 엣지 속성 융합 :** $E^t_{S-U}$(S,U)의 경우, 우리는 배달 수용량 모델로부터 얻은 edge 임베딩 $em^c_{us,t}$ 과 edge 속성 $φ_{us,t}$을 결합합하여 새로운 edge 속성을 얻는다. 이는  배달 용량, 배송 거리 및 역사적 관계 등 다양한 요소를 포함한다. 새로운 edge 속성  $φ_{us,t}$ 는  $φ_{us,t}$ = [ $φ_{us,t}$,  $em^c_{us,t}$ ] 로 정의된다.

**(3) 노드 수준 집계 :** 기간 t에서 하위 그래프 $G^t_h$에서, 각 노드는 이웃들로부터 정보를 집계하여 자신의 노드 임베딩을 업데이트한다. 장획하게는 매장-지역 모델링과 매장-유형 모델링을 통해 각각 매장-지역 노드 임베딩과 매장-유형 노드 임베딩을 얻는다.

- **(3-1) 매장-지역 모델링.** 한편, target 노드 매장 지역의 경우 $E^t_{S-U}$를 통해 배송 범위 내에서 고객-지역의 선호도를 학습한다(propagation). 반면 $E_{S-A}$ 를 통해 매장-지역과 매장-유형 간으 ㅣ상위 상호 작용 정보를 관측한다. I번째 집계 후 매장-지역 노드 s의 임베딩 $h^l_{s,t}$ 는 다음과 같이 정의한다.   
![E-7](/assets/img/paperview/o2o/E-7.png)    
여기서 $W^l_S$ 는 훈련 가능한 가중치다. $N^t_{S-U}(s)$ 및 $N_{S-A}(s)$는 각각 $E^t_{S-U}$ 및 $E_{S-A}$ 매장-지역 s의 이웃을 나타낸다. Aggre는 집계 함수이며 나중에 자세히 정의된다. $Z^{l-1}_{u,t}$, $q^{l-1}_{a,t}$, $h^{l-1}_{s,t}$ 는 (l-1)번째 집계 후 고객-지역 노드 u, 매장-유형 노드 a, 매장-지역 노드 s의 임베딩이다. 고객-지역 노드 u의 경우 임베딩 $Z^{l-1}_{u,t}$ 는 다음과 같이 정의되는 I번째 집계 후  $E^t_{U-A}$ 를 통해 선호하는 매장 유형을 포착한다.    
![E-8](/assets/img/paperview/o2o/E-8.png)    
여기서 $W^l_S$ 는 학습 가능한 가중치이고  $N^t_{A-U}$ 는 $E^t_{U-A}$ 를 기반으로 한 고객-지역 노드 u의 이웃을 나타낸다.   
  
- **(3-2) 매장-유형 모델링** target 노드 매장 유형의 경우 $E_{S-A}$를 통해 상호 작용하는 매장 지역과 상위 정보를 캡처한다. I번째 집계 후 저장 유형 노드 a의 임베딩 $q^l_{a,t}$ 는 다음과 같이 정의됩니다.  
![E-9](/assets/img/paperview/o2o/E-9.png)     
여기서 $W^l_A$는 훈련 가능한 가중치를 의미하고 $N_{A-S}(a)$ 는 $E_{S-A}$에 기반한 상점 유형 a의 이웃을 나타낸다.

**Aggregation function(Aggre).** 이종 그래프에서 서로 다른 Edge 유형과 Edge의 속성을 고려하기 위해 노드 속성, Edge속성 및 Edge 유형별로 각 소스 노드의 중요도를 추정하는 집계 함수를 설계한다.

다중 헤드 주의 메커니즘을 활용하여 중요도 점수를 계산한다. 다음 매장-지역 노드(target 노드)와 customerregion노드(즉, 소스 노드)를 예로 사용한다. 먼저, 서로 다른 Edge 유형의 영향을 고려하기 위해 동일한 Edge 유형에서 공유하는 훈련 가능한 매개변수 $W_e$를 설정한다. 그 다음 Edge 속성을 활용하기 위해 소스 노드(예: 고객 영역 u)의 임베딩 $Z^{l-1}_{u,t}$ 와 Edge 속성 $φ_{us,t}$ 를 융합 벡터로 결합한다. i번째 어텐션 헤드의 경우 위의 퓨즈 벡터를 선형 프로젝션 $W^i_{k, U}$를 사용하여 i번째 key 벡터에 프로젝션 한다. i번째 키 벡터 $K^i(u)$는 다음과 같이 정의된다.  
![E-10](/assets/img/paperview/o2o/E-10.png)

마찬가지로 선형 프로젝션 $W^i_{q,S}$를 사용하여 target 노드(예, 매장-지역 노드)를 i번째 쿼리 벡터에 프로젝션한다. i번째 쿼리 벡터는 $Q^i(s)$ = $W^i_{q,S}h^{l-1}_{s, t}$ 로 정의된다. 마지막으로 쿼리 벡터, 키 벡터 및 Edge 유형을 결합하여 i 번째 어텐션 헤드의 중요도를 계산하고 softmax함수로 정규화하여 i번째 어텐션 헤드의 가중치를 얻는다. 이것은 다음과 같이 정의한다.  
![E-11](/assets/img/paperview/o2o/E-11.png)  

그 다음 이웃 노드의 정보를 집계하고 멀티 헤드 어텐션의 출력을 연결하여 Aggre의 최종 표현을 얻는다. 이것은 다음과 같이 정의된다.  
![E-12](/assets/img/paperview/o2o/E-12.png)  

여기서 || 연산자는 vector 연결 연산자를 나타낸다.

**(4) 시간 의미론 수준 집계 : 기간 t 동안 각 하위 그래프에 매장-지역 및 매장-유형(즉 $h^i_{s,t}$, $q^l_{a,t}$)를 삽입하여 먼저 연결 $H_{sq,t} = [H^l_{s,t}, q^l{a,t}]$. 서로 다른 기간에 동등하지 않은 중요성을 갖는다는 점을 고려하여 멀티 헤드 어텐션 메커니즘을 활용하여 각 기간의 중요성을 계산한다. i번째 어텐션 헤드의 경우 모든 기간의 연결된임베딩을 선형 프로젝션 $W^i_k$를 사용하여 i번째 키 벡터 $K^i_{t_j}(H_{sa})$ 로 프로젝션한다. 이것은 다음과 같이 정의한다. 

![E-13](/assets/img/paperview/o2o/E-13.png)  


